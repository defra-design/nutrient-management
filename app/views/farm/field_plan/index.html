{% extends "layouts/main.html" %}

{% block pageTitle %}
  Nutrient Application Plan – {{ serviceName }} – GOV.UK
{% endblock %}

{% block header %}
  {% include "/templates/headers/header_farm.html" ignore missing %}
{% endblock %}

{% block beforeContent %}
  {{ govukBackLink({
    text: "Back to the " + data.oaktree_farm.planning_year + " farm plan",
    href: "plan_view_reset_router"
  }) }}
{% endblock %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    {% if data.show_success_message == true %}
      {% include "./templates/success_message.html" ignore missing %}
    {% elif data.oaktree_farm.planning_year == 2025 %}
      {% include "./templates/important_message.html" ignore missing %}
    {% endif %}
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">

    <div class="margin-bottom-forty">      
      <span class="name govuk-caption-l">{{ data.oaktree_farm.name }}</span>
      <h1 id="main-title" class="govuk-heading-l margin-bottom-forty">{{data.chosen_field.field_name}} plan {{data.oaktree_farm.planning_year}}</h1>
      <p class="govuk-body">Last updated 22 September 2025.</p>
    </div>

    <div class="govuk-tabs" data-module="govuk-tabs">
      <h2 class="govuk-tabs__title">Contents</h2>
      <ul class="govuk-tabs__list">
        <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
          <a class="govuk-tabs__tab" href="#recs">
            Nutrient and Lime recommendations
          </a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#manures">
            Organic and inorganic material
          </a>
        </li>
        <li class="govuk-tabs__list-item">
          <a class="govuk-tabs__tab" href="#crops">
            Crop, field and soil details
          </a>
        </li>
      </ul>

      <!-- show the right table -->
      <!-- go throguh the manure applications -->
      <!-- if this field appears in them, set organic = true -->

      <!-- go throguh the fertiliser applications -->
      <!-- if this field appears in them, set inorganic = true -->

      {% set organics = false %}
      {% set inorganics = false %}

      {% for manureapp in data.manureApplications %}
        {% if manureapp.fieldref == data.fieldref %}
          {% set organics = true %}
        {% endif %}
      {% endfor %}

      {% for fertapp in data.fertiliserApplications %}
        {% if fertapp.fieldref == data.fieldref %}
          {% set inorganics = true %}
        {% endif %}
      {% endfor %}

      <!-- recs -->
      <div class="govuk-tabs__panel" id="recs">
        <h2 id="cropone" class="govuk-heading-m">
          Nutrient and Lime recommendations for 
          {{data.chosen_field.crop_id | nameconverter}} 
          in
          {{data.chosen_field.field_name}}
        </h2>
        {% if data.chosen_field.crop_id == 'grass' %}
          {% include "./templates/recs_templates/grass.html" ignore missing %}
        {% else %}
          {% include "./templates/recs_templates/arable.html" ignore missing %}
        {% endif %}
      </div>
      
      <!-- manures -->
      {% include "./templates/manures.html" ignore missing %}

      <!-- crops -->
      {% include "./templates/crops.html" ignore missing %}

    </div>

  </div>
</div>

{% endblock %}